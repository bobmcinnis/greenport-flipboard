<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Greenport Solari â€“ Safe Fallback</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { background:#111; color:#eee; font-family:Arial,sans-serif; text-align:center; margin:0; padding:20px; }
  h1, h2 { margin: 12px 0; }
  .board, .sponsors, .timetableRow { display:flex; justify-content:center; margin:20px auto; flex-wrap:nowrap; width:100%; max-width:95vw; }
  .flap { position:relative; flex:0 0 30px; margin:1px; aspect-ratio: 2/3; perspective:600px; }
  @media (min-width: 700px){ .flap{ flex-basis:40px; } }
  @media (min-width: 1100px){ .flap{ flex-basis:50px; } }

  /* Halves */
  .half { position:absolute; left:0; width:100%; height:50%; overflow:hidden; backface-visibility:hidden; }
  .top { top:0; transform-origin:bottom; transform:rotateX(0deg); height:calc(50% + 3px); }
  .bottom { bottom:0; transform-origin:top; transform:rotateX(0deg); height:calc(50% + 3px); }

  .half img { position:absolute; width:100%; height:100%; object-fit:cover; display:block; }
  .top img { bottom:0; }
  .bottom img { top:0; }

  .flip-top .top { animation: topOut 0.25s linear forwards; }
  @keyframes topOut { 0% {transform:rotateX(0)} 100% {transform:rotateX(-90deg)} }
  .flip-bottom .bottom { animation: bottomIn 0.25s linear forwards; }
  @keyframes bottomIn { 0% {transform:rotateX(90deg)} 100% {transform:rotateX(0)} }

  #muteBtn { position:fixed; top:15px; right:15px; background:#444; color:#fff; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; font-size:18px; z-index:999; }
  #countdown { margin-top:8px; font-size:1.15rem; color:#ffeb3b; }
  .notice { color:#ff6; font-size:0.95rem; opacity:0.9; }
</style>
</head>
<body>
  <h1>Greenport Solari</h1>
  <div class="board" id="mainBoard"></div>
  <div id="countdown">Next Departure in -- min -- sec</div>
  <div id="timetable"></div>
  <h2>Sponsors</h2>
  <div class="sponsors" id="sponsorBoard"></div>
  <p class="notice" id="status"></p>
  <button id="muteBtn" aria-label="Toggle sound">ðŸ”Š</button>
  <audio id="tick" src="tick.m4a" preload="auto"></audio>

<script>
const ASSET_BASE="greenport_splitflap_basic/assets";
const NAME_MAP={":":"colon","-":"dash",".":"period",",":"comma","/":"slash","&":"ampersand","?":"question","!":"exclamation"," ":"space"};
function labelFor(ch){return NAME_MAP[ch]??ch;}
const mainBoard=document.getElementById("mainBoard"),sponsorBoard=document.getElementById("sponsorBoard"),timetableEl=document.getElementById("timetable"),countdownEl=document.getElementById("countdown"),tickSound=document.getElementById("tick"),muteBtn=document.getElementById("muteBtn"),status=document.getElementById("status");
let soundEnabled=true,phrases={main:[],sponsors:[],departures:[]},mainIndex=0,sponsorIndex=0,currentMain="",currentSponsor="",currentDepartureIndex=0,previousTimetableStrs=[];

muteBtn.addEventListener("click",()=>{soundEnabled=!soundEnabled;muteBtn.textContent=soundEnabled?"ðŸ”Š":"ðŸ”‡"});

function buildFlapHTML(ch){const label=labelFor(ch);return`
<div class="half top"><img class="current" src="${ASSET_BASE}/top/${label}.png" alt=""><img class="next" src="${ASSET_BASE}/top/${label}.png" style="display:none" alt=""></div>
<div class="half bottom"><img class="current" src="${ASSET_BASE}/bottom/${label}.png" alt=""><img class="next" src="${ASSET_BASE}/bottom/${label}.png" style="display:none" alt=""></div>`}

function buildBoardExact(word,board,idPrefix="row"){board.innerHTML="";for(let i=0;i<word.length;i++){const ch=word[i],flap=document.createElement("div");flap.className="flap";flap.id=`${idPrefix}Flap${i}`;flap.innerHTML=buildFlapHTML(ch);board.appendChild(flap)}}

function flipTile(flap,fromCh,toCh,playTick){if(fromCh===toCh)return;const topHalf=flap.querySelector(".top"),bottomHalf=flap.querySelector(".bottom"),topCur=topHalf.querySelector("img.current"),topNext=topHalf.querySelector("img.next"),botCur=bottomHalf.querySelector("img.current"),botNext=bottomHalf.querySelector("img.next"),toLabel=labelFor(toCh);
topNext.src=`${ASSET_BASE}/top/${toLabel}.png`;botNext.src=`${ASSET_BASE}/bottom/${toLabel}.png`;flap.classList.add("flip-top");if(playTick){try{tickSound.currentTime=0;tickSound.play()}catch(e){}}
topHalf.addEventListener("animationend",function onTopEnd(){topHalf.removeEventListener("animationend",onTopEnd);flap.classList.remove("flip-top");topCur.src=topNext.src;botCur.src=botNext.src;bottomHalf.style.transform="rotateX(90deg)";flap.classList.add("flip-bottom");if(playTick){try{tickSound.currentTime=0;tickSound.play()}catch(e){}}
bottomHalf.addEventListener("animationend",function onBottomEnd(){bottomHalf.removeEventListener("animationend",onBottomEnd);flap.classList.remove("flip-bottom");bottomHalf.style.transform=""},{once:true})},{once:true})}

function flipRowTo(board,currentText,targetText,idPrefix="row",staggerMs=100,playTick=true){const len=Math.max(currentText.length,targetText.length),cur=(currentText+" ".repeat(len)).slice(0,len),next=(targetText+" ".repeat(len)).slice(0,len);
if(board.children.length!==len)buildBoardExact(cur,board,idPrefix);for(let i=0;i<len;i++){const flap=document.getElementById(`${idPrefix}Flap${i}`),fromCh=cur[i],toCh=next[i];setTimeout(()=>flipTile(flap,fromCh,toCh,playTick),i*staggerMs)}}

function hardcodedFallback(){
  phrases={
    main:["WELCOME TO GREENPORT","GREENPORT EXPRESS","DEPARTURES TODAY"],
    sponsors:["THANKS TO CLAUDIO'S","SUPPORTED BY SATNICK JEWELERS","ALDO'S COFFEE"],
    departures:[new Date(Date.now()+5*60000), new Date(Date.now()+45*60000), new Date(Date.now()+90*60000)]
  };
  status.textContent="Loaded fallback data (phrases.json unavailable).";
  currentMain=phrases.main[0]; buildBoardExact(currentMain,mainBoard,"main");
  currentSponsor=phrases.sponsors[0]; buildBoardExact(currentSponsor,sponsorBoard,"sponsor");
  updateNextDepartureIndex(); renderOrFlipTimetable(true);
  setInterval(cycleMain,5000); setInterval(cycleSponsors,4000); setInterval(tickCountdownAndTimetable,1000);
}

async function loadPhrases(){
  try{
    const res=await fetch("phrases.json", {cache:"no-store"});
    if(!res.ok) throw new Error("phrases.json not found");
    const raw=await res.json();
    phrases={
      main: raw.main||[],
      sponsors: raw.sponsors||[],
      departures: (raw.departures||[]).map(d=>new Date(d))
    };
    if(phrases.main.length===0) throw new Error("phrases.json has no 'main' entries");

    currentMain=phrases.main[0]; buildBoardExact(currentMain,mainBoard,"main");
    currentSponsor=phrases.sponsors[0]||""; buildBoardExact(currentSponsor,sponsorBoard,"sponsor");
    updateNextDepartureIndex(); renderOrFlipTimetable(true);
    setInterval(cycleMain,5000); setInterval(cycleSponsors,4000); setInterval(tickCountdownAndTimetable,1000);
    status.textContent="";
  }catch(err){
    console.error(err);
    status.textContent="Could not load phrases.json â€“ using fallback data.";
    hardcodedFallback();
  }
}

function cycleMain(){const nextMain=phrases.main[mainIndex];flipRowTo(mainBoard,currentMain,nextMain,"main",100,soundEnabled);currentMain=nextMain;mainIndex=(mainIndex+1)%phrases.main.length}
function cycleSponsors(){const nextSponsor=phrases.sponsors[sponsorIndex];flipRowTo(sponsorBoard,currentSponsor,nextSponsor,"sponsor",90,soundEnabled);currentSponsor=nextSponsor;sponsorIndex=(sponsorIndex+1)%phrases.sponsors.length}

function updateNextDepartureIndex(){const now=new Date();currentDepartureIndex=phrases.departures.findIndex(d=>d>now);if(currentDepartureIndex===-1){countdownEl.textContent="No more departures today"}}
function formatTime(d){return d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}
function renderOrFlipTimetable(initial=false){
  if(currentDepartureIndex===-1){timetableEl.innerHTML="";return}
  const upcoming=phrases.departures.slice(currentDepartureIndex,currentDepartureIndex+3),newTimes=upcoming.map(formatTime);
  if(initial||JSON.stringify(newTimes)!==JSON.stringify(previousTimetableStrs)){
    if(initial||timetableEl.children.length!==newTimes.length){
      timetableEl.innerHTML="";
      newTimes.forEach((s,i)=>{const row=document.createElement("div");row.className="timetableRow";row.id=`row${i}`;timetableEl.appendChild(row);buildBoardExact(s,row,`row${i}`)});
    }else{
      newTimes.forEach((s,i)=>{const row=document.getElementById(`row${i}`),oldStr=previousTimetableStrs[i]||"";flipRowTo(row,oldStr,s,`row${i}`,80,soundEnabled)});
    }
    previousTimetableStrs=[...newTimes];
  }
}
function tickCountdownAndTimetable(){
  if(currentDepartureIndex===-1) return;
  const now=new Date(), target=phrases.departures[currentDepartureIndex];
  let diff=target-now;
  if(diff<=0){
    currentDepartureIndex++;
    if(currentDepartureIndex>=phrases.departures.length){countdownEl.textContent="No more departures today";timetableEl.innerHTML="";return}
    renderOrFlipTimetable(false); diff=phrases.departures[currentDepartureIndex]-new Date();
  }
  const mins=Math.floor(diff/60000),secs=Math.floor((diff%60000)/1000);
  countdownEl.textContent=`Next Departure in ${mins} min ${secs} sec`;
}

loadPhrases();
</script>
</body>
</html>
